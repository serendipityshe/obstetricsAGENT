<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产科医学问答助手</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 5px; line-height: 1.6; } /* 最小化页面边距 */
        .container { background-color: #f5f5f5; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: calc(100vh - 20px); } /* 减小容器内边距和整体高度 */
        h1 { color: #2c3e50; text-align: center; margin: 5px 0; font-size: 18px; } /* 最小化标题尺寸和间距 */
        .conversation-container { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: white; } /* 最大化对话区域 */
        .message { margin-bottom: 10px; max-width: 75%; animation: fadeIn 0.3s ease-in-out; } /* 增加消息宽度占比 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { margin-left: auto; }
        .user-message .message-content { background-color: #3498db; color: white; border-radius: 15px 15px 5px 15px; }
        .ai-message { margin-right: auto; }
        .ai-message .message-content { background-color: #ecf0f1; border-radius: 15px 15px 15px 5px; }
        .message-content { padding: 8px 12px; word-wrap: break-word; font-size: 14px; } /* 减小消息内边距和字体 */
        .message-meta { font-size: 0.7em; color: #7f8c8d; margin-top: 3px; text-align: right; } /* 减小元数据字体 */
        .question-form { display: flex; flex-direction: column; gap: 8px; } /* 减小表单元素间距 */
        textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 50px; resize: none; font-size: 14px; } /* 减小输入框尺寸 */
        .controls { display: flex; gap: 5px; align-items: flex-end; } /* 最小化按钮间距 */
        button { background-color: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; height: 32px; } /* 减小按钮尺寸 */
        button:hover { background-color: #2980b9; }
        button.clear-btn { background-color: #95a5a6; }
        button.clear-btn:hover { background-color: #7f8c8d; }
        .loading { color: #7f8c8d; text-align: center; padding: 8px; font-size: 14px; } /* 减小加载提示尺寸 */
        .error { color: #e74c3c; padding: 8px; text-align: center; font-size: 14px; } /* 减小错误提示尺寸 */
        .input-row { display: flex; gap: 5px; align-items: flex-end; } /* 减小输入行间距 */
        .file-upload { flex-grow: 1; font-size: 13px; } /* 减小文件上传区域字体 */
        #userType { padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px; height: 32px; } /* 减小下拉框尺寸 */
    </style>
</head>
<body>
    <div class="container">
        <h1>产科医学问答助手</h1>
        <div class="conversation-container" id="conversationContainer"></div>
        <div class="question-form">
            <select id="userType">
                <option value="doctor">医生</option>
                <option value="pregnant_mother">孕妇</option>
            </select>
            <div class="input-row">
                <textarea id="question" placeholder="请输入您的产科医学问题...按Shift+Enter换行，Enter发送"></textarea>
                <div class="controls">
                    <button onclick="submitQuestion()">发送</button>
                    <button class="clear-btn" onclick="newConversation()">新建对话</button>
                </div>
            </div>
            <div class="file-upload">
                <input type="file" id="imageUpload" accept=".pdf,.docx,.doc,.txt,.png,.jpg,.jpeg">
            </div>
            <div class="loading" id="loading" style="display: none;">正在获取答案...</div>
            <div class="error" id="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 页面加载完成后自动聚焦到输入框
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('question').focus();
            // 加载保存的对话历史
            loadConversationHistory();
        });

        // 为输入框添加回车发送功能
        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitQuestion();
            }
        });

        function addMessageToHistory(role, content) {
            const container = document.getElementById('conversationContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${role}-message message`;
            messageDiv.innerHTML = `
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                <div class="message-meta">${role === 'user' ? '您' : 'AI'} · ${new Date().toLocaleTimeString()}</div>
            `;
            container.appendChild(messageDiv);
            // 平滑滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        function saveConversationHistory() {
            // 在实际应用中，您可能需要将历史保存到localStorage
            // 这里仅在内存中维护历史
        }

        function loadConversationHistory() {
            // 在实际应用中，您可能需要从localStorage加载历史
            // 这里暂不实现
        }

        function newConversation(){
            document.getElementById('conversationContainer').innerHTML = '';
            document.getElementById('question').focus();
            fetch('/api/new_conversation', {
                method: 'POST',
                credentials: 'include'
            });
        }

        function clearHistory() {
            if (confirm('确定要清空对话历史吗？')) {
                document.getElementById('conversationContainer').innerHTML = '';
                document.getElementById('question').focus();
            }
        }

        function submitQuestion() {
            const question = document.getElementById('question').value.trim();
            const userType = document.getElementById('userType').value;
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const questionInput = document.getElementById('question');

            if (!question) {
                alert('请输入问题内容');
                return;
            }

            // 添加用户消息到对话历史
            addMessageToHistory('user', question);

            // 清空输入框并显示加载状态
            questionInput.value = '';
            loading.style.display = 'block';
            error.style.display = 'none';

            const formData = new FormData();
            formData.append('query', question);
            formData.append('user_type', userType);
            const imageUpload = document.getElementById('imageUpload');
            if (imageUpload.files.length > 0) {
                formData.append('image', imageUpload.files[0]);
                // 上传后清除文件选择
                imageUpload.value = '';
            }

            fetch('/api/qa', {
                method: 'POST',
                body: formData,
                credentials: 'include'  // 确保包含cookie以维持会话
            })
            .then(response => {
                loading.style.display = 'none';
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.error || '获取答案失败'); });
                }
                return response.json();
            })
            .then(data => {
                // 添加AI消息到对话历史
                addMessageToHistory('ai', data.answer);
                saveConversationHistory();
            })
            .catch(err => {
                error.textContent = err.message;
                error.style.display = 'block';
                // 移除最后一条用户消息（因为发送失败）
                const container = document.getElementById('conversationContainer');
                container.removeChild(container.lastChild);
            })
            .finally(() => {
                questionInput.focus();
            });
        }
    </script>
</body>
</html>